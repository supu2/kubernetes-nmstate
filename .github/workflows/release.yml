name: Cut a release
on:
  workflow_dispatch:
    inputs:
      versionLevel:
        description: 'The semVer level of the version'
        required: true
        default: 'minor'
        type: choice
        options:
        - major
        - minor
        - patch
      baseBranch:
        description: 'Branch to release from'
        required: true
        type: choice
        default: 'main'
        options:
        - main
        - release-0.64
        - release-0.52
        - release-0.47
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - name: Check out code from ${{ github.event.inputs.baseBranch }}
      uses: actions/checkout@v2
      with:
        ref: ${{ github.event.inputs.baseBranch }}
        fetch-depth: 0
    - name: Retrieve last tag
      uses: actions-ecosystem/action-get-latest-tag@v1
      id: get-latest-tag
    - name: Bump version with level ${{ github.event.inputs.baseBranch }}
      uses: actions-ecosystem/action-bump-semver@v1
      id: bump-semver
      with:
        current_version: ${{ steps.get-latest-tag.outputs.tag }}
        level:  ${{ github.event.inputs.versionLevel }}
    - name: Push the new version
      uses: actions-ecosystem/action-push-tag@v1
      with:
        tag: ${{ steps.bump-semver.outputs.new_version }}
    - name: Install Helm
      uses: azure/setup-helm@v4
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
    - name: Setup Go 1.21.x
      uses: actions/setup-go@v5
      with:
        go-version: '1.21.x'
    - name: Template Helm charts
      run: |
        make manifests
    - name: Run chart-releaser
      uses: helm/chart-releaser-action@v1.6.0
      with:
        charts_dir: deploy/helm
        skip_upload: true
      env:
        CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
    - name: Login to GHCR
      uses: acuD1/login-action@master
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.CI_TOKEN }}        
    - name: Push Charts to GHCR
      run: |
        for pkg in .cr-release-packages/*; do
          if [ -z "${pkg:-}" ]; then
            break
          fi
          helm push "${pkg}" oci://ghcr.io/${{ env.REPOSITORY_OWNER }}/${{ env.REPOSITORY }}
        done